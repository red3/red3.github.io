<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Harry" />
    
    <title>Scrapy+MySQL+PHP+Swift开发攻略系列（五）之API篇</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="red3 harry" type="application/atom+xml" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/media/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script type="text/javascript"> hljs.initHighlightingOnLoad(); </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="red3 harry" class="" href="/">red3 harry</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Gallery" href="http://redthree.lofter.com"><i class="fa fa-film"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>Scrapy+MySQL+PHP+Swift开发攻略系列（五）之API篇 </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2015-09-09">2015-09-09</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#Linux" title="Linux">#Linux</a>
    
    <a href="/tags.html#Scrapy" title="Scrapy">#Scrapy</a>
    
    <a href="/tags.html#Swift" title="Swift">#Swift</a>
    
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span
    class           = "like-wrapper"
    like-shortname  = 'gopherwood'
    like-identifier = ''
    like-name       = 'Scrapy+MySQL+PHP+Swift开发攻略系列（五）之API篇'
    like-btn        = '&#xf087;'
    like-link       = '/2015/09/09/fullstack-of-Scrapy+MySQL+PHP+Swift5.html'
    ></span>
  <script type="text/javascript">
    var l = document.createElement('script');
    l.type = 'text/javascript'; l.async = true; l.src = 'http://www.like-btn.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <h2 id="section">系列目录</h2>

<p>你可以从这个地方做一个快速跳转。</p>

<ul>
  <li><a href="http://blog.coderharry.com/2015/08/08/fullstack-of-Scrapy+MySQL+PHP+Swift1.html">Scrapy+MySQL+PHP+Swift开发攻略系列（一）之前言篇</a></li>
  <li><a href="http://blog.coderharry.com/2015/08/08/fullstack-of-Scrapy+MySQL+PHP+Swift2.html">Scrapy+MySQL+PHP+Swift开发攻略系列（二）之爬虫篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（三）之数据库MySQL篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（四）之爬虫被封+爬虫自动运行篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（五）之API篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（六）之RESTAPI篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（七）之Swift篇</a></li>
</ul>

<h2 id="section-1">温故知新</h2>

<p>在前面的系列中，我们编写了爬虫，并且设置爬虫在每天的固定时间运行，对于频繁的爬虫请求，设置了随机的<code>User-Agent</code>，到现在为止，我们的数据库中应该已经存储了大量的数据，如图：</p>

<p><img src="/assets/2015/fullstack_api01.png" alt="" /></p>

<p>此次系列我们要编写<code>PHP</code>程序，提供客户端跟后台通信的接口。</p>

<h2 id="section-2">准备工作</h2>

<p>开始之前，确保机器上已经装有Apache、MySQL和PHP。好在Mac上已经自带Apache和PHP了，之前的系列中我们也在机器上安装了MySQL。要启用Apache，在终端执行下面的命令：</p>

<pre><code>sudo apachectl start
</code></pre>

<p>Mac上的Apache默认WWW目录是在<code>/Library/WebServer/Documents</code>，如果有需要，可以把默认WWW目录改成其他目录。</p>

<p>Apache默认是没有启用PHP支持的，要开启的话，应该这样：</p>

<pre><code>sudo vi /etc/apache2/httpd.conf
// 找到下面这行，将前面的#去掉
# LoadModule php5_module libexec/apache2/libphp5.so
// 重启Apache
sudo apachectl start
</code></pre>

<h2 id="php">创建PHP工程</h2>

<p>环境搭好以后，我们需要测试一下是否服务器可以正常工作。在WWW目录下新建一个名为<code>test.php</code>的文件，写入下面的测试代码。然后通过在浏览器中访问<code>http://localhost//test.php</code>可以在窗口中看到”Hello, World”说明正常工作了。</p>

<pre><code>// test.php
&lt;?php
	echo "Hello, World";
?&gt;
</code></pre>

<h2 id="phpmysql">通过PHP连接MySQL</h2>

<p>现在需要一个PHP类来连接MySQL，这个类的主要目的就是打开或者关闭一个连接到数据库的连接。所以创建两个文件：config.db.php 和 database.class.php.</p>

<ul>
  <li>config.db.php : 配置数据库连接的用户名、密码、端口等。</li>
  <li>database.class.php : 创建一个到数据库的连接</li>
</ul>

<p>以下为这两个文件的代码</p>

<p><strong>config.db.php</strong></p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">config.db.php</span>
<span class="cp">&lt;?php</span>
 
<span class="cm">/*</span>
<span class="cm"> * All database connection variables</span>
<span class="cm"> */</span>
 
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;DB_USERNAME&#39;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">);</span> <span class="c1">// User</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;DB_PASSWORD&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// Passwd</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;DB_DATABASE&#39;</span><span class="p">,</span> <span class="s2">&quot;dbmeizi&quot;</span><span class="p">);</span> <span class="c1">// Database</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;DB_HOST&#39;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">);</span> <span class="c1">// Server</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;DB_PORT&#39;</span><span class="p">,</span> <span class="mi">3307</span><span class="p">);</span> <span class="c1">// Port</span>
<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p><strong>database.class.php</strong></p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">database.class.php</span>
<span class="cp">&lt;?php</span>
 
<span class="sd">/**</span>
<span class="sd"> * A class file to connect to database</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">DbConnect</span> <span class="p">{</span>
 
    <span class="c1">// constructor</span>
    <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
 
    <span class="c1">// destructor</span>
    <span class="k">function</span> <span class="nf">__destruct</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
 
    <span class="sd">/**</span>
<span class="sd">     * Function to connect with database</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// import database connection variables</span>
        <span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/config.db.php&#39;</span><span class="p">;</span>
 
        <span class="c1">// Connecting to mysql database</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mysqli</span><span class="p">(</span><span class="nx">DB_HOST</span><span class="p">,</span> <span class="nx">DB_USERNAME</span><span class="p">,</span> <span class="nx">DB_PASSWORD</span><span class="p">,</span> <span class="nx">DB_DATABASE</span><span class="p">,</span> <span class="nx">DB_PORT</span><span class="p">);</span>
 
        <span class="c1">// Check for database connection error</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mysqli_connect_errno</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">&quot;Failed to connect to MySQL: &quot;</span> <span class="o">.</span> <span class="nx">mysqli_connect_error</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SET NAMES utf8&quot;</span><span class="p">);</span> 
        <span class="c1">// returing connection resource</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>说明：在接下来的工程中，当我们需要使用数据库连接的时候，可以使用下面的代码：</p>

<pre><code>$db = new DbConnect(); 
$conn = $db-&gt;connect();
</code></pre>

<h2 id="phpmysql-crud">通过PHP进行基本的MySQL CRUD操作</h2>

<p>接下来进行通过PHP操作数据库，CRUD代表Create, Read, Update, Delete</p>

<h3 id="reading-all-rows-from-mysql">1.Reading All Rows from MySQL</h3>

<p>要读取数据库中我们抓取的meizi的列表，创建一个文件 <strong>girllist.php</strong> ，写入下面的代码</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
 
<span class="cm">/*</span>
<span class="cm"> * get girl list </span>
<span class="cm"> */</span>
 
<span class="nv">$response</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
 
<span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/include/database.class.php&#39;</span><span class="p">;</span> 
 
<span class="c1">// connecting to db</span>
<span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbConnect</span><span class="p">();</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">();</span>


<span class="c1">// 默认页数</span>
<span class="nv">$size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$page</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$start</span> <span class="o">=</span> <span class="nv">$size</span> <span class="o">*</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
 
<span class="c1">// get girl list from table</span>

<span class="c1">// new girl</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM meizi WHERE 1 = 1 ORDER BY id DESC LIMIT </span><span class="si">{</span><span class="nv">$start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nv">$size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetch_all</span><span class="p">(</span><span class="nx">MYSQLI_ASSOC</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// check for empty result</span>
    <span class="c1">// success</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no girl found</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No girl found&quot;</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

<span class="p">}</span>
    
<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>在浏览器访问这个文件，成功获取列表的时候：</p>

<pre><code>{
	code: 1,
	msg: "success",
	list: [
		{
			id: "160",
			title: "睡不着 秒回么？",
			imgsrc: "http://ww2.sinaimg.cn/bmiddle/0060lm7Tgw1evush3zicwj30dw0iu41b.jpg",
			topic_link: "http://www.dbmeinv.com/dbgroup/417098",
			star_count: "0",
			update_time: "1441697041"
		},
		{
			id: "159",
			title: "【晒】",
			imgsrc: "http://ww2.sinaimg.cn/bmiddle/0060lm7Tgw1evusfx74ipj30dw0iitbl.jpg",
			topic_link: "http://www.dbmeinv.com/dbgroup/417122",
			star_count: "0",
			update_time: "1441697041"
		}
	]
}
</code></pre>

<h3 id="updating-a-row-in-mysql">2.Updating a Row in MySQL</h3>

<p>之前的系列中提到过，用户可以给某个meizi点赞，实现这个功能创建一个文件 <strong>likegirl.php</strong> ，写入下面的代码</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
 
<span class="cm">/*</span>
<span class="cm"> * like a girl </span>
<span class="cm"> */</span>
 
<span class="c1">// array for JSON response</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
 
<span class="c1">// include db connect class</span>
<span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/include/database.class.php&#39;</span><span class="p">;</span> 
 
<span class="c1">// connecting to db</span>
<span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbConnect</span><span class="p">();</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">();</span>
 

<span class="c1">// id of the girl</span>
<span class="nv">$girlid</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;girlid&#39;</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$girlid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$girlid</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oops, you need to tell me the girl&#39;s id&quot;</span><span class="p">;</span>
     <span class="k">exit</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">));</span>
<span class="p">}</span>
<span class="c1">// let the girl&#39;s startcount + 1</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;UPDATE meizi set star_count = star_count + 1 WHERE id = </span><span class="si">{</span><span class="nv">$girlid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// check for empty result</span>
    <span class="c1">// success</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no girl found</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$response</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>在浏览器中访问这个文件，注意要拼接上<code>girlid</code>参数和对应的值。成功点赞的时候：</p>

<pre><code>{
	code: 1,
	msg: "success"
}
</code></pre>

<p>至此，我们已经实现了跟客户端通信的一套基本框架，其他功能都可以在这个基础上拓展。</p>

<h2 id="section-3">最后</h2>

<p>按照惯例，放上源码地址：</p>


  </section>
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2015 ~ 2015 Harry | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi">sext vi</a> | fork <a href="https://github.com/red3" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
