<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Harry" />
    
    <title>Scrapy+MySQL+PHP+Swift开发攻略系列（四）之爬虫被封+爬虫自动运行篇</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="red3 harry" type="application/atom+xml" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/media/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script type="text/javascript"> hljs.initHighlightingOnLoad(); </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="red3 harry" class="" href="/">red3 harry</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Gallery" href="http://redthree.lofter.com"><i class="fa fa-film"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>Scrapy+MySQL+PHP+Swift开发攻略系列（四）之爬虫被封+爬虫自动运行篇 </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2015-09-08">2015-09-08</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#Linux" title="Linux">#Linux</a>
    
    <a href="/tags.html#Scrapy" title="Scrapy">#Scrapy</a>
    
    <a href="/tags.html#Swift" title="Swift">#Swift</a>
    
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span
    class           = "like-wrapper"
    like-shortname  = 'gopherwood'
    like-identifier = ''
    like-name       = 'Scrapy+MySQL+PHP+Swift开发攻略系列（四）之爬虫被封+爬虫自动运行篇'
    like-btn        = '&#xf087;'
    like-link       = '/2015/09/08/fullstack-of-Scrapy+MySQL+PHP+Swift4.html'
    ></span>
  <script type="text/javascript">
    var l = document.createElement('script');
    l.type = 'text/javascript'; l.async = true; l.src = 'http://www.like-btn.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <h2 id="section">系列目录</h2>

<p>你可以从这个地方做一个快速跳转。</p>

<ul>
  <li><a href="http://blog.coderharry.com/2015/08/08/fullstack-of-Scrapy+MySQL+PHP+Swift1.html">Scrapy+MySQL+PHP+Swift开发攻略系列（一）之前言篇</a></li>
  <li><a href="http://blog.coderharry.com/2015/08/08/fullstack-of-Scrapy+MySQL+PHP+Swift2.html">Scrapy+MySQL+PHP+Swift开发攻略系列（二）之爬虫篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（三）之数据库MySQL篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（四）之爬虫被封+爬虫自动运行篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（五）之API篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（六）之RESTAPI篇</a></li>
  <li><a href="">Scrapy+MySQL+PHP+Swift开发攻略系列（七）之Swift篇</a></li>
</ul>

<h2 id="section-1">防止爬虫被封</h2>

<p>系列（二）中提到过，对于一个网络请求，网站后台可能会检查其<code>User-Agent</code>，所以一个防止爬虫可行的做法就是设置请求的<code>User-Agent</code>。对于频繁的请求，还要对<code>User-Agent</code>做随机变换。</p>

<p>可以通过<code>Downloader Middleware</code>来修改爬虫的request和respons。</p>

<h3 id="downloader-middleware">使用下载器中间件(Downloader Middleware)</h3>

<p>要激活下载器中间件组件，需要将其加入到<code>DOWNLOADER_MIDDLEWARES</code>设置中。 该设置是一个字典(dict)，键为中间件类的路径，值为其中间件的顺序(order)。</p>

<pre><code>DOWNLOADER_MIDDLEWARES = {
'dbmeizi.middlewares.RandomUserAgent': 1
}
</code></pre>

<p>因为要使用随机的<code>User-Agent</code>，所以在设置中，顺便加上随机<code>User-Agent</code>的配置：</p>

<pre><code>USER_AGENTS = [
"Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5",
"Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.85 Safari/537.36",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_4) AppleWebKit/600.7.12 (KHTML, like Gecko) Version/8.0.7 Safari/600.7.12",
]
</code></pre>

<h3 id="section-2">编写下载器中间件</h3>

<p>创建一个中间件文件<code>middlewares.py</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="k">class</span> <span class="nc">RandomUserAgent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">crawler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&#39;USER_AGENTS&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">))</span></code></pre></div>

<h2 id="section-3">自动运行</h2>

<p>为了源源不断获取数据，要每天都运行爬虫抓取数据，显然每次都人为发起爬虫是不切实际的。</p>

<p>在Mac上可以通过<code>crontab</code>让爬虫定时自动执行。</p>

<pre><code>// 为当前用户新增任务
crontab -e
// 增加如下记录 注意替换自己的爬虫目录 由于环境变量的原因，scrapy要给出全路径
0 10 * * * cd /Users/herui/Sites/dbmeizi &amp;&amp; /usr/local/bin/scrapy crawl dbmeiziSpider
</code></pre>

<p>如上，添加了一个任务，这个任务会每天早上10：00启动，这个任务要做得就是进入爬虫目录，并启动爬虫。</p>

<p>不过查了下，Mac上目前好像不太推荐用<code>crontab</code>了，推荐使用<code>launchd</code>. 有机会可以了解下。</p>

<h2 id="section-4">最后</h2>

<p>按照惯例，放上源码地址：</p>


  </section>
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2015 ~ 2015 Harry | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi">sext vi</a> | fork <a href="https://github.com/red3" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
