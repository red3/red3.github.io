<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Harry" />
    
    <title>Mac OS X 中为Apache开启ssl</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="red3 harry" type="application/atom+xml" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/media/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script type="text/javascript"> hljs.initHighlightingOnLoad(); </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="red3 harry" class="" href="/">red3 harry</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Gallery" href="http://redthree.lofter.com"><i class="fa fa-film"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>Mac OS X 中为Apache开启ssl </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2015-06-24">2015-06-24</time>
  </span>
  
  <span class="tags">
    
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span
    class           = "like-wrapper"
    like-shortname  = 'gopherwood'
    like-identifier = ''
    like-name       = 'Mac OS X 中为Apache开启ssl'
    like-btn        = '&#xf087;'
    like-link       = '/2015/06/24/Mac-OS-ssl.html'
    ></span>
  <script type="text/javascript">
    var l = document.createElement('script');
    l.type = 'text/javascript'; l.async = true; l.src = 'http://www.like-btn.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <p>最近由于工作需要，需要给Mac本地的Apache配置ssl环境，折腾了一下午，终于解决了，把过程记录下来，留给有需要的人。</p>

<ul>
  <li>生成ssl证书</li>
</ul>

<ol>
  <li>
    <p>生成主机密匙 （’ssl’这个文件夹可以随意起名字，只要在后面的设置中保持一致即可）</p>

    <pre><code> sudo mkdir /private/etc/apache2/ssl
 cd /private/etc/apache2/ssl
 sudo ssh-keygen -f server.key
</code></pre>
  </li>
  <li>
    <p>生成证书请求文件（这个过程感觉跟iOS生成开发证书类似）</p>

    <pre><code> sudo openssl req -new -key server.key -out request.csr
 	// 这个过程中会让输入一些证书机构的信息，按照提示或者留空就行
</code></pre>
  </li>
  <li>
    <p>使用server.key 和 request.csr 生成ssl证书</p>

    <pre><code> sudo openssl x509 -req -days 365 -in request.csr -signkey server.key -out server.crt
</code></pre>
  </li>
</ol>

<ul>
  <li>配置Apache</li>
</ul>

<ol>
  <li>
    <p>编辑httpd.conf文件</p>

    <p>sudo vi /private/etc/apache2/httpd.conf</p>
  </li>
</ol>

<p>去掉下面四行前面的 ‘#’</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">LoadModule ssl_module libexec/apache2/mod_ssl.so</span>
<span class="x">LoadModule socache_shmcb_module libexec/apache2/mod_socache_shmcb.so</span>
<span class="x">Include /private/etc/apache2/extra/httpd-ssl.conf</span>
<span class="x">Include /private/etc/apache2/extra/httpd-vhosts.conf</span></code></pre></div>

<ol>
  <li>
    <p>编辑httpd-ssl.conf文件</p>

    <p>sudo vi /private/etc/apache2/extra/httpd-ssl.conf</p>
  </li>
</ol>

<p>将以下两行：</p>

<pre><code>SSLCertificateFile "/private/etc/apache2/server.crt"

SSLCertificateKeyFile "/private/etc/apache2/server.key"
</code></pre>

<p>分别修改为：（需要注意的是ssl文件夹为第1步创建的文件夹）</p>

<pre><code>SSLCertificateFile "/private/etc/apache2/ssl/server.crt"

SSLCertificateKeyFile "/private/etc/apache2/ssl/server.key"
</code></pre>

<p>需要注意的是该文件68行的代码会在Apache运行的时候报错</p>

<pre><code>SSLMutex  "file:/private/var/run/ssl_mutex"
</code></pre>

<p>查找网上的解决方案是将这行代码注释，不知道会不会带来安全隐患，烦请知道的同学告知。</p>

<ol>
  <li>编辑httpd-vhosts.conf文件</li>
</ol>

<p>在文件末尾添加：</p>

<pre><code>&lt;VirtualHost *:443&gt; 
SSLEngine on
SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
SSLCertificateFile /private/etc/apache2/ssl/server.crt 
SSLCertificateKeyFile /private/etc/apache2/ssl/server.key
ServerName localhost
// copy your DocumentRoot setting in httpd.conf to here
DocumentRoot "/Users/$yourName/Sites"
&lt;/VirtualHost&gt;
</code></pre>

<p>这时需要注意，httpd-vhosts.conf文件里面有个默认的 &lt;VirtualHost *:80&gt;标签， 不做修改的话，访问localhost会报错:The Request / Not Found</p>

<p>这是因为&lt;VirtualHost *:80&gt;里的设置会覆盖以前单站点模式下的设置, 所以要把该文件里的一些设置同步过来, 我把他修改成这样:</p>

<pre><code>&lt;VirtualHost *:80&gt;
ServerAdmin xxx@example.com
// copy your DocumentRoot setting in httpd.conf to here
DocumentRoot "/Users/$yourName/Sites"
ServerName localhost
ErrorLog "/private/var/log/apache2/error_log"
CustomLog "/private/var/log/apache2/access_log" common
&lt;/VirtualHost&gt; 
</code></pre>

<p>进行到这里就配置完了，重启Apache，访问https://localhost试试吧！</p>

<pre><code>sudo apachectl configtest
sudo apachectl restart
</code></pre>

<ul>
  <li>后记</li>
</ul>

<p>其实最近折腾这个主要是为了练习iOS应用框架中使用SSL加密以及实现iOS自动打包至服务器使用itms-service协议自动安装至手机的过程，然而由于服务器缺少https环境，本地https又缺少SA认证，尚未实现，权当给自己挖个坑，钻研钻研吧！</p>

<p>参考：</p>

<p><a href="http://www.cnblogs.com/y500/p/3596473.html">http://www.cnblogs.com/y500/p/3596473.html</a></p>

<p><a href="http://stackoverflow.com/questions/13969272/apache-sslmutex-issue">http://stackoverflow.com/questions/13969272/apache-sslmutex-issue</a></p>


  </section>
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2015 ~ 2015 Harry | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi">sext vi</a> | fork <a href="https://github.com/red3" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
