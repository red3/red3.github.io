---
layout: post
title:  "微信的开发同学真机智"
date:   2016-1-3 12:40:00
---

## 前言

这次事情的缘由是这样的：微信的最近升级去除了下拉录制小视频的功能，改为了仅仅拉出一张微信logo的图片。其实这里有个细节问题需要注意，因为首页聊天列表页顶部的SearchBar的背景是灰色，所以下拉出来的视图应该也是灰色，这样看着才是协调的。创建过置顶聊天的同学应该知道，置顶聊天的Cell也是灰色，其他Cell的背景是白色的。

![](http://photo-coder.b0.upaiyun.com/img/inspect-the-view-hierarchy-of-wechat01.png)

当时我就想，这个需求其实只要把TableView的背景设置成灰色就可以了，然后在TableView的负坐标上加上一个图片就可以了，恩，就是这么简单。

然后，又滑了滑列表，毕竟是too young, too simple啊。

刚才说过，普通的Cell的背景是白色的，那么如果将TableView的背景设置成灰色，那么底部的Cell都滑到底后，会出现列表的背景灰色，这样就又会显得不协调。事实证明，微信这么注重细节的产品不会犯这种错误，滑动到列表底部，出现的依然是白色背景。

所以仅仅改变TableView的背景色看来是不够的。


## 模拟实现

如果换我实现这个功能，我就保持列表的背景为白色，然后在负坐标上加一个View，View的背景是灰色的，View上再加上这个图片logo，然后在列表滑动的时候，需要动态改变这个View的高度，不然又会看见白色背景了。
当然这个实现稍微有点复杂，因为如果动态改变View的高度，那么就要监听TableView的滑动，如果这些监听放在ViewController里面去做，会显臃肿，如果坚持良好的设计模式的话，显然不太理想。不能在ViewController里面做这件事的话，可以考虑给TableView加一个拓展，在拓展里面让这个View注册为TableView的观察者，当TableView的offset变化时，让自身的高度变化。

## 验证

可不可以验证下，微信是怎么处理的，当然可以！

越狱了一台iPad，用`Reveal`检查微信的视图层级后发现聊天列表顶部
只有一个孤零零的UIImageview，所以可以肯定的是微信团队并没有按照上文那样用一个View去实现，就是简单的调用了一行代码：

```objective-c
[self.tableView addSubView:imageView];
```

然后就是注意修改这个imageview的坐标为负坐标就行了。

至此，可以推断TableView的背景色应该就是灰色的了，不然没法解释下拉出来的logo图片的背景是灰色的。

那列表底部拉出的白色背景的问题是怎么处理的呢？

![]()

可以从上面的图片中看到，第一个UIimageview就是微信logo图片，那么底部的问题应该就出在选中的UIView这一块，从frame属性中查看，发现高度是748，什么样的View竟然需要这么高的高度？相信你已经猜到什么了。

暴力一点，直接把这个View的高度改为10pt，背景色改为红色，然后效果是这样的：

![]()

Bingo, 果然就是在footerView上加了个背景为白色的很高的一个View。
如果你还有疑问，为什么这个高度是748，而不是848或者别的数字呢，如果你知道iPad横屏模式下高度为768pt，再减去状态栏的高度20pt，就是这个高度，意味着无论你怎么用力滑，都是滑不出这个高度的，真是机智啊！

这个时候有人不禁会问，真把footerView设置这么高，实际上是可以多滑动出一个footerView的高度的距离的。因此只能把footerView的高度设置为0，然后在上面添加子View，让子View的高度为748，就是上图中的那个结构。

然后顺便看了下这个地方有两个view，那么另外一个view的作用是什么呢，根据frame发现，y坐标为-0.5，高为0.5，难道那个是最底部的那个横跨全屏的分割线？

在iPhone中仔细又研究了下：

![](http://photo-coder.b0.upaiyun.com/img/inspect-the-view-hierarchy-of-wechat04.png)

看来果然是为了做横跨全屏的分割线啊，因为放大点是能看到最后的Cell的分割线跟这个View重合了，但是左边分明能看到有没有重合的地方粗线不一样，哈哈，看来细心如微信，也有疏忽的地方啊！

## 思考

关于Cell分割线的问题，在我就职过的公司中有各种各样的需求，有时候需要这个分割线是布满整个屏幕的，而苹果UIKit中默认的实现是从屏幕左边15pt开始的，只能往后延伸，并不能再往前延伸，这是苹果做的限制，因为只有这样，才是一个表格视图应有的表现。
有时候要硬生生在两个Cell中间加个10pt左右的分隔，这样的话Cell默认的分割线就没法用了，只能隐藏默认的分割线然后在内容底部自己再造一个分割线。
最终，这次实践我的思考就是移动UI设计师一定要了解平台上的设计规范，依据设计规范出来的东西开发好实现，平台上的用户接受成本也低，而不按照设计规范出来的东西，开发需要用一些千奇百怪的方式来实现需求，后人维护也会觉得莫名其妙。

另外，微信关于列表底部视图白色的背景处理也是值得我们学习的，这样其实是最快，最高效实现这个需求的方案，并且也是性能最好的。按照我最初的想法，需要在列表每次滑动的时候都进行运算，反而不好。

## 后记

为什么用iPad作这个实验而不用iPhone？一开始是用iPhone来着，用了两个iPhone越狱后都让我折腾白苹果了，只能刷到最新的固件，最新的固件又还没发越狱。所以血与泪的教训告诉我，越狱不容易，不要瞎折腾。



