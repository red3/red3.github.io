---
layout: post
title:  "iOS 开发神器：利用 Surge 访问内网接口"
date:   2016-5-22 14:00:00
---
注1：本文基于 Surge 1.2.4版本，后续版本可能存在操作差异。

## 以前怎么做以及存在的问题

相信大多数移动端开发者都面临过这样的问题：开发过程中需要访问内网服务器资源，有些公司的内网环境需要修改 host 才可以访问，甚至有的公司需要连 vpn 认证才可以访问，比如我们公司。由于在手机上修改 host 不太方便，所以就有了这样的流程：

在电脑上打开 `Charles` 或者 `Fiddler` 等抓包工具，开启代理服务器，获取电脑的 IP 地址，然后在手机当前连接的 WIFI 代理设置中填入对应的电脑的 IP 地址和端口。

这么做可以满足需求，但是也有些问题：

1. 操作过于繁琐与频繁。我跟我们公司的测试同事沟通的时候了解到，手机上的 WIFI 网络设置了 HTTP 代理后必须依赖电脑上的抓包软件联网，因此，当电脑无法提供代理服务的时候我们就需手动关闭手机的代理设置。而下次调试，不可避免地还需要再次设置代理信息。常见的场景诸如在公司调试了接口，回到家发现无法联网，关闭代理后第二天到公司又得重新设置代理。

2. 安全问题。如果手机上连接的是别人的电脑上的代理服务，那么自己手机中的所有 HTTP 连接都会通过代理服务器电脑来转发，这样的话，所有的通信内容都暴漏到代理服务器电脑上了。

## iOS9 后新的解决方案

好在 iOS9.0 后苹果开放了 `Network Extension`，使得手机上也可以执行代理请求了。意味着我们可以动态将手机上的网络请求做代理处理。具体来说就是可以指定某个域名下的请求走代理。这一特性将大大方便我们在手机上更改代理的需求。因为这一特性，我们可以将代理服务常驻后台，保证只有特定请求才后走代理，不会影响手机其他上的其他请求，同时解决了上述的操作繁琐问题与安全问题。

满足这一需求的软件有很多，诸如 `Surge`, `Shadowrocks`, `A.BIG.T`等。本文将拿 Surge 为例来说明怎么通过代理软件简化我们的开发调试流程。

* 新建一条代理路线

编辑配置文件，新建代理(Edit->Add New Proxy...)，然后依据电脑端具体代理规则来填写具体代理服务的 ip 地址和端口，如下图是我依据我的电脑的 ip 来配置了一个名为 dev-api 的代理。这里需要说明的是，如果是用 Charles 来作代理服务的同学需要在电脑上开启 SOCKS 代理，因为 Surge 会将 HTTP 请求转发成 CONNECT，而 Charles 不支持 CONNECT 请求的抓包。

![](http://photo-coder.b0.upaiyun.com/img/use-surge-to-proxy-http-request01.png)

* 建立代理规则

上文有提到过，使用代理软件可以做到针对指定域名下的请求走代理服务。而在 Surge 中将指定域名称为规则。所以我们需要新建一条规则来告诉 Surge 当请求匹配这个规则的时候要走代理服务的路线。

点击配置文件中 Rules 进入规则设置界面，然后新建一条规则(Edit->Rules->右上角+)，如图:

![](http://photo-coder.b0.upaiyun.com/img/use-surge-to-proxy-http-request02.png)


Surge支持 DOMAIN, SUFFIX, KEYWORD, IP, GEOIP这几种类型的规则，很明显我们选择 DOMAIN 类型的规则，然后在 VALUE 里面填入内网服务器的域名，例如 `dev-api.mobile.lashou.com`, 凡是发往这个域名的请求都会成功匹配我们的规则。

光匹配到请求还不够，接下来还有最关键的一步，那就是指定这条规则应该执行哪条代理路线。进入代理选择页面我们会发现有几个可供选择的项目，DIRECT, REJECT, dev-api(我们刚才新建的代理)。这里特别说明一下这三者代表的意思：

* DIRECT 默认行为，表示请求直接手机发出
* REJECT 表示请求直接被拒绝，不会发出
* dev-api 表示请求会交由代理服务器转发

Surge 比较人性化的一点是可以支持代理 group，意味着你可以创建多个代理服务器，然后把它们加入一个代理 group 里面，然后针对不同的规则，匹配不同的代理服务器。

通过上面的步骤，我们便轻松完成了类似情形下访问内网服务器接口的问题。并且这是个一劳永逸的过程，一次设置，终身受用，哈哈。顺着这个思路，我们也可以把手机上访问 google 的请求转发到其他代理服务器上以实现科学上网的诉求，这些就留给读者自己发挥了。


最后还有一个温馨提示，如果有些接口只是通过修改 host 就可以访问，而不需要 vpn 认证的话，直接就可以在手机上完成，在配置文件中的 `Locan DNS Map` 设置与电脑上的 hosts 文件功能类似，只需要在里面加入跟电脑一样的规则就好了。


