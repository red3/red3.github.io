---
layout: post
title:  "iOS 开发神器：利用 Surge 访问内网接口"
date:   2016-5-22 14:00:00
---


## 旧的解决方案


相信大多数移动端开发者都面临过这样的问题：开发过程中需要访问内网服务器资源，有些公司的内网环境需要修改 host 才可以访问，甚至有的公司需要连 vpn 认证才可以访问，比如我们公司。由于在手机上修改 host 不太方便，所以就有了这样的流程：

在电脑上打开 `Charles` 或者 `Fiddler` 等抓包工具，开启代理服务器，获取电脑的 IP 地址，然后在手机当前连接的 WIFI 代理设置中填入 对应的 IP 和端口。

这么做可以满足需求，但是也有些问题：

1. 操作过于繁琐与频繁。公司的测试同事跟我沟通的时候提到过，这个方案需要在手机上频繁输入 IP 和端口等信息。因为手机上的WIFI网络设置的代理信息后必须依赖电脑上的抓包软件才可以联网，因此，当电脑无法提供代理服务的时候我们就需手动关闭手机的代理设置。而下次调试，不可避免地还需要再次设置代理信息。

2. 安全问题。如果连接的是别人的电脑上的代理，那么自己手机中的所有 http 连接都会走代理服务器电脑，这样的话，所有的通信内容都暴漏到别人的眼皮底下。

## iOS9 后的解决方案

好在 iOS9.0 后苹果开放了 Network Extension，使得手机上也可以执行代理请求了。意味着我们可以动态将手机上的网络请求做代理处理。再具体点就是可以指定某个域名下的请求走代理。这一特性将大大方便我们在手机上更改代理的需求。

满足这一需求的软件有很多，诸如 `Surge`, `Shadowrocks`, `A.BIG.T`等。本文将拿 Surge 为例来说明怎么通过代理软件简化我们的开发调试流程。

* 新建一条代理路线

编辑配置文件，新建代理，然后依据电脑端具体代理规则来填写具体代理服务的 ip 地址和端口，如下图是我依据我的电脑的 ip 来配置的代理。这里需要说明的是，如果是用 Charles 来作代理服务的同学需要在电脑上开启 socket 代理，因为Surge 会将 http 协议转发成 connect 协议，而 Charles 不支持 Connect 协议的抓包。

![](http://photo-coder.b0.upaiyun.com/img/use-surge-to-proxy-http-request01.png)

* 建立代理规则

上文有提到过，使用代理软件可以做到针对指定域名下的请求走代理服务。而在 Surge 中将指定域名称为规则。所以我们需要新建一条规则来告诉 Surge 当请求匹配这个规则的时候要走代理服务的路线。

点击配置文件中 Rules 进入规则设置界面，然后新建一条规则，如图。

![](http://photo-coder.b0.upaiyun.com/img/use-surge-to-proxy-http-request02.png)


Surge支持 DOMAIN, SUFFIX, KEYWORD, IP, GEOIP这几种类型的规则，很明显我们选择 DOMAIN 类型的规则，然后在 VALUE 里面填入内网服务器的域名，例如 api72.mobile.lashou.com, 凡是发往这个域名的请求都会成功匹配我们的规则。

刚匹配到请求还不够，接下来还有最关键的一步，那就是指定这条规则应该执行哪条代理路线。进入代理选择页面我们会发现有几个可供选择的项目，DIRECT, REJECT, dev-api(我们刚才新建的代理)。这里特别说明一下这三者代表的意思：

* DIRECT 默认行为，表示请求直接手机发出
* REJECT 表示请求直接被拒绝，不会发出
* api72 表示请求会交由代理服务器转发

Surge 比较人性化的一点是可以支持代理 group，意味着你可以创建多个代理服务器，然后把它们加入一个代理 group 里面，然后针对不同的规则，匹配不同的代理服务器。


最后还有一个温馨提示，如果有些接口只是通过修改 host 就可以访问，而不需要 vpn 认证的话，直接就可以在手机上完成，在配置文件中的 `Locan DNS Map` 设置与电脑上的 hosts 文件功能类似，只需要在里面加入跟电脑一样的规则就好了。



另外 Surge 还支持通知中心拓展插件。


